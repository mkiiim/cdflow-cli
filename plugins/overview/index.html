<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Overview - cdflow CLI Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../css/typography.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">cdflow CLI Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Usage & Config</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../usage/" class="dropdown-item">Usage Guide</a>
</li>
                                    
<li>
    <a href="../../configuration/" class="dropdown-item">Configuration</a>
</li>
                                    
<li>
    <a href="../../data_formats/" class="dropdown-item">Data Formats</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Plugins</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Overview</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../troubleshooting/" class="nav-link">Troubleshooting</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../contributing/" class="nav-link">Contributing</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Legal</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../license/" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../../cla/" class="dropdown-item">CLA</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../data_formats/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../troubleshooting/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#donationflow-cli-plugin-examples" class="nav-link">DonationFlow CLI Plugin Examples</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#what-are-plugins" class="nav-link">What are Plugins?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#installation" class="nav-link">Installation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#available-examples" class="nav-link">Available Examples</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creating-your-own-plugins" class="nav-link">Creating Your Own Plugins</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#plugin-execution" class="nav-link">Plugin Execution</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#tips" class="nav-link">Tips</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#adapter-support" class="nav-link">Adapter Support</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#need-help" class="nav-link">Need Help?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="donationflow-cli-plugin-examples">DonationFlow CLI Plugin Examples</h1>
<p>This directory contains example plugins demonstrating the DonationFlow CLI plugin system.</p>
<h2 id="what-are-plugins">What are Plugins?</h2>
<p>Plugins allow you to customize donation data processing without modifying the core DonationFlow CLI code. They execute at different stages of the import process:</p>
<ul>
<li><strong>row_transformer</strong>: Transform CSV data during mapper initialization (dictionary phase)</li>
<li><strong>field_processor</strong>: Process individual fields during parsing (future, not implemented)</li>
<li><strong>donation_validator</strong>: Validate/modify complete donation objects (future, not implemented)</li>
</ul>
<h3 id="execution-phases">Execution Phases</h3>
<p><strong>Dictionary Phase (row_transformer):</strong>
- Executes during <code>DonationMapper.__init__()</code> before object construction completes
- Works with row data as a dictionary (Python <code>dict</code>)
- Can read/modify dictionary entries
- Can add underscore fields (<code>_field_name</code>) that mappers will consume
- Cannot access mapper object properties (they don't exist yet)
- This is where plugins set business logic fields via underscore convention</p>
<p><strong>Object Phase (field_processor, donation_validator - future):</strong>
- Would execute after mapper object is fully constructed
- Would work with <code>DonationMapper</code> object and its <code>NBfield_name</code> properties
- Would have full access to all NationBuilder fields
- Not yet implemented</p>
<h2 id="installation">Installation</h2>
<p>Plugin examples are automatically copied when you run <code>cdflow init</code>:</p>
<div class="highlight"><pre><span></span><code>cdflow<span class="w"> </span>init
</code></pre></div>
<p>This creates:
- <code>~/.config/cdflow/plugins/canadahelps/</code> - CanadaHelps plugin examples
- <code>~/.config/cdflow/plugins/paypal/</code> - PayPal plugin examples</p>
<p>All plugin files start with <code>_</code> prefix (disabled by default). To enable a plugin, remove the <code>_</code> prefix:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Example: Enable the eligibility filter plugin</span>
<span class="nb">cd</span><span class="w"> </span>~/.config/cdflow/plugins/canadahelps/
mv<span class="w"> </span>_99_eligibility_filter.py<span class="w"> </span>99_eligibility_filter.py
</code></pre></div>
<p>Then configure plugins in your <code>~/.config/cdflow/local.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">plugins</span><span class="p">:</span>
<span class="w">  </span><span class="nt">canadahelps</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;~/.config/cdflow/plugins/canadahelps&quot;</span>
<span class="w">  </span><span class="nt">paypal</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;~/.config/cdflow/plugins/paypal&quot;</span>
</code></pre></div>
<h2 id="available-examples">Available Examples</h2>
<h3 id="canadahelps-plugins-cdflow_cliexamplespluginscanadahelps">CanadaHelps Plugins (<code>cdflow_cli/examples/plugins/canadahelps/</code>)</h3>
<h4 id="00_check_number_formatterpy"><code>00_check_number_formatter.py</code></h4>
<p>Formats check numbers with "CH_" prefix using the transaction number field.</p>
<h4 id="10_anonymous_emailpy"><code>10_anonymous_email.py</code></h4>
<p>Handles anonymous donor emails. Sets custom email addresses for anonymous CanadaHelps donations.</p>
<h4 id="20_tracking_code_mapperpy"><code>20_tracking_code_mapper.py</code></h4>
<p>Maps donations to tracking codes based on MONTHLY GIFT ID field. Monthly donations get a different tracking code than one-time donations.</p>
<h4 id="30_payment_type_mapperpy"><code>30_payment_type_mapper.py</code></h4>
<p>Maps CanadaHelps payment methods to NationBuilder payment types (e.g., "ApplePay" → "Apple Pay", "Cheque" → "Check").</p>
<h4 id="40_sanitize_anon_fieldspy"><code>40_sanitize_anon_fields.py</code></h4>
<p>Replaces all "ANON" values with empty strings. CanadaHelps uses "ANON" to mark anonymous donor information.</p>
<h4 id="99_eligibility_filterpy"><code>99_eligibility_filter.py</code></h4>
<p>Filters ineligible donations. Sets <code>_skip_row</code> flag for records missing receiptable amount or missing both name and email.</p>
<h3 id="paypal-plugins-cdflow_cliexamplespluginspaypal">PayPal Plugins (<code>cdflow_cli/examples/plugins/paypal/</code>)</h3>
<h4 id="00_check_number_formatterpy_1"><code>00_check_number_formatter.py</code></h4>
<p>Formats check numbers with "PP_" prefix using the transaction ID field.</p>
<h4 id="10_external_id_lookuppy"><code>10_external_id_lookup.py</code></h4>
<p>Person lookup by external ID for PayPal transactions.</p>
<h4 id="20_tracking_code_mapperpy_1"><code>20_tracking_code_mapper.py</code></h4>
<p>Maps Item Title to tracking codes using substring matching (e.g., "month" → membership_paypal_monthly).</p>
<h4 id="30_payment_type_mapperpy_1"><code>30_payment_type_mapper.py</code></h4>
<p>Maps PayPal transaction types to NationBuilder payment types.</p>
<h4 id="99_eligibility_filterpy_1"><code>99_eligibility_filter.py</code></h4>
<p>Filters ineligible donations. Sets <code>_skip_row</code> flag for duplicate records (Custom Number populated) or records missing both name and email.</p>
<h2 id="creating-your-own-plugins">Creating Your Own Plugins</h2>
<h3 id="basic-template">Basic Template</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cdflow_cli.plugins.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_plugin</span>

<span class="nd">@register_plugin</span><span class="p">(</span><span class="s2">&quot;canadahelps&quot;</span><span class="p">,</span> <span class="s2">&quot;row_transformer&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_custom_plugin</span><span class="p">(</span><span class="n">row_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Describe what your plugin does.</span>

<span class="sd">    Args:</span>
<span class="sd">        row_data: Raw CSV row as dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        Modified row_data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Your transformation logic here</span>

    <span class="k">return</span> <span class="n">row_data</span>
</code></pre></div>
<h3 id="plugin-types">Plugin Types</h3>
<p><strong>row_transformer</strong> - Transforms raw CSV row data before parsing
<div class="highlight"><pre><span></span><code><span class="nd">@register_plugin</span><span class="p">(</span><span class="s2">&quot;canadahelps&quot;</span><span class="p">,</span> <span class="s2">&quot;row_transformer&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_transformer</span><span class="p">(</span><span class="n">row_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># Modify row_data dictionary</span>
    <span class="k">return</span> <span class="n">row_data</span>
</code></pre></div></p>
<p><strong>field_processor</strong> <em>(coming soon)</em> - Processes individual field values
<div class="highlight"><pre><span></span><code><span class="nd">@register_plugin</span><span class="p">(</span><span class="s2">&quot;canadahelps&quot;</span><span class="p">,</span> <span class="s2">&quot;field_processor&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_processor</span><span class="p">(</span><span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">row_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="c1"># Modify specific field value</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></p>
<p><strong>donation_validator</strong> <em>(coming soon)</em> - Validates/modifies complete donation objects
<div class="highlight"><pre><span></span><code><span class="nd">@register_plugin</span><span class="p">(</span><span class="s2">&quot;canadahelps&quot;</span><span class="p">,</span> <span class="s2">&quot;donation_validator&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_validator</span><span class="p">(</span><span class="n">donation</span><span class="p">:</span> <span class="n">DonationMapper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DonationMapper</span><span class="p">:</span>
    <span class="c1"># Validate or modify donation object</span>
    <span class="k">return</span> <span class="n">donation</span>
</code></pre></div></p>
<h2 id="plugin-execution">Plugin Execution</h2>
<ul>
<li>Plugins execute in <strong>alphabetical order</strong> by filename</li>
<li>Use numeric prefixes (<code>00_</code>, <code>10_</code>, <code>20_</code>, etc.) to control execution order</li>
<li>Disable plugins by prefixing filename with underscore (e.g., <code>_99_eligibility_filter.py</code>)</li>
<li>Example plugins from <code>cdflow init</code> start disabled with <code>_</code> prefix - remove <code>_</code> to enable</li>
</ul>
<h3 id="recommended-ordering-convention">Recommended Ordering Convention</h3>
<p><strong>00-09</strong>: Special operations (formatting, person lookup, etc.)
<strong>10-89</strong>: Data transformations (tracking codes, payment types, field mapping)
<strong>90-99</strong>: Filtering/validation (eligibility checks, _skip_row flags)</p>
<p>Example:
<div class="highlight"><pre><span></span><code>00_check_number_formatter.py # Format: standardize check numbers
10_external_id_lookup.py     # Lookup: person by external ID
20_tracking_code_mapper.py   # Transform: set tracking code
30_payment_type_mapper.py    # Transform: set payment type
40_sanitize_anon_fields.py   # Transform: clean anonymous fields
99_eligibility_filter.py     # Filter: skip ineligible records (LAST)
</code></pre></div></p>
<p><strong>Why this order?</strong> Transform data first, then filter. This is more efficient and ensures filtering decisions are based on complete, transformed data.</p>
<h3 id="plugin-to-mapper-communication-api">Plugin-to-Mapper Communication API</h3>
<p>Plugins communicate with mappers through an <strong>underscore field convention</strong>. This is an intentional API contract where plugins set <code>_field_name</code> entries in the row dictionary, and the mapper base class consumes them to populate corresponding <code>NBfield_name</code> properties.</p>
<h4 id="business-logic-fields">Business Logic Fields</h4>
<p>These underscore fields map directly to NationBuilder donation fields:</p>
<table>
<thead>
<tr>
<th>Plugin Sets</th>
<th>Mapper Reads As</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_check_number</code></td>
<td><code>NBcheck_number</code></td>
<td>Formatted check/transaction number</td>
</tr>
<tr>
<td><code>_payment_type</code></td>
<td><code>NBpayment_type_name</code></td>
<td>Payment type (e.g., "Check", "Apple Pay")</td>
</tr>
<tr>
<td><code>_tracking_code</code></td>
<td><code>NBtracking_code_slug</code></td>
<td>Campaign tracking code</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># Plugin sets underscore field</span>
<span class="n">row_data</span><span class="p">[</span><span class="s2">&quot;_check_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CH_</span><span class="si">{</span><span class="n">transaction_number</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Base class reads it (donation.py line 77)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">NBcheck_number</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_check_number&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="control-fields">Control Fields</h4>
<p>These fields control import processing behavior:</p>
<ul>
<li><code>_skip_row</code>: Set to <code>True</code> to mark record as ineligible (skips donation creation)</li>
<li><code>_skip_reason</code>: Detailed reason for skipping (logged in fail file)</li>
</ul>
<h4 id="important-notes">Important Notes</h4>
<ul>
<li><strong>Underscore fields are intentional</strong>: Plugins explicitly know they're providing values for NationBuilder fields</li>
<li><strong>Fields are filtered</strong>: Underscore fields don't appear in CSV output files</li>
<li><strong>Execution timing</strong>: Plugins run during mapper initialization, before the mapper object is fully constructed</li>
<li><strong>Dictionary phase</strong>: Plugins work with the row dictionary; they cannot access mapper object properties or methods</li>
</ul>
<h2 id="tips">Tips</h2>
<ul>
<li><strong>Keep plugins simple</strong> - One plugin should do one thing well</li>
<li><strong>Handle errors gracefully</strong> - Plugin errors are logged but don't stop the import</li>
<li><strong>Test with small datasets</strong> first before running on production data</li>
<li><strong>Document your plugins</strong> - Future you will thank you</li>
</ul>
<h2 id="adapter-support">Adapter Support</h2>
<p>Currently supported adapters:
- <code>canadahelps</code>
- <code>paypal</code></p>
<p>Each adapter has its own plugins directory.</p>
<h2 id="need-help">Need Help?</h2>
<ul>
<li>Check the <a href="../../docs/">main documentation</a></li>
<li>Review the example plugins in this directory</li>
<li>Test plugins with a small CSV file first</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
